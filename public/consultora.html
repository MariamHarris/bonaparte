<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="es" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bonaparte - Consultora</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .chat-box { background: #0b1220; border: 1px solid #1f2937; border-radius: 12px; padding: 10px; min-height: 120px; }
      .chat-bubble { margin-bottom: 10px; padding: 10px; border-radius: 10px; line-height: 1.4; }
      .chat-user { background: #0ea5e9; color: #0b1220; text-align: right; }
      .chat-bot { background: #111827; color: #e5e7eb; border: 1px solid #1f2937; }
      .chat-meta { font-size: 12px; color: #cbd5e1; margin-bottom: 4px; }
      .chat-suggestions { font-size: 12px; color: #a5b4fc; margin-top: 6px; }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="nav">
          <span class="brand">Bonaparte</span>
          <a href="/">Público</a>
          <a href="/empresa.html">Empresa</a>
          <a href="/consultora.html">Consultora</a>
          <span class="badge">UI: 8080</span>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="hero">
        <h1>Panel Consultora</h1>
        <p>Gestiona empresas, estadísticas e invoicing del peaje por interacción con un panel claro y protegido.</p>
      </div>
      <section class="card">
        <h2>Consultora: acceso</h2>
        <div class="row">
          <div>
            <h3>Login</h3>
            <label>Username</label>
            <input id="loginUser" placeholder="consultora_demo" />
            <label>Password</label>
            <input id="loginPass" type="password" placeholder="demo123" />
            <div class="inline" style="margin-top:10px;">
              <button id="btnLogin" class="fit">Entrar</button>
              <button id="btnLogout" class="secondary fit">Salir</button>
            </div>
            <div class="small muted" style="margin-top:10px;">Token guardado en LocalStorage (solo demo).</div>
          </div>

          <div>
            <h3>Registro (Consultora)</h3>
            <label>Username</label>
            <input id="regUser" placeholder="consultora_nueva" />
            <label>Password</label>
            <input id="regPass" type="password" placeholder="demo123" />
            <button id="btnRegister" style="margin-top:10px;">Crear cuenta</button>
          </div>
        </div>

        <hr />
        <div class="small muted">Estado actual:</div>
        <pre id="authOut">(sin sesión)</pre>
      </section>

      <section class="card">
        <h2>Empresa consultora</h2>
        <div class="small muted">Datos de referencia y rol en el peaje/facturación (solo informativo en el prototipo).</div>
        <ul class="small">
          <li>Razón social de ejemplo: Consultores Chiriquí, S.A.</li>
          <li>Rol: administra peaje por interacciones y emite factura emulada DGI.</li>
          <li>Acceso sólo con usuario/contraseña de consultora (JWT).</li>
        </ul>
      </section>

      <section class="card">
        <h2>Empresas registradas</h2>
        <div class="inline" style="margin-top:10px;">
          <button id="btnLoadCompanies" class="fit">Cargar empresas</button>
          <button id="btnClearCompanies" class="secondary fit">Limpiar</button>
          <button id="btnLoadReplication" class="secondary fit">Ver replicación (vivo)</button>
        </div>
        <div id="companiesPager" class="inline pager" style="margin-top:10px; display:none;">
          <button id="btnCompaniesPrev" class="secondary fit">Anterior</button>
          <div id="companiesPagerMeta" class="pager-meta"></div>
          <button id="btnCompaniesNext" class="secondary fit">Siguiente</button>
        </div>
        <div id="companiesList" class="list" style="margin-top:12px;"></div>
        <div id="replicationList" class="list" style="margin-top:12px;"></div>
      </section>

      <section class="card">
        <h2>Estadísticas</h2>
        <div class="row">
          <div>
            <h3>Por empresa</h3>
            <label>Company ID</label>
            <input id="statsCompanyId" placeholder="(pega un companyId)" />
            <button id="btnLoadStatsCompany" style="margin-top:10px;">Cargar stats</button>
          </div>
          <div>
            <h3>Por vacante</h3>
            <label>Vacancy ID</label>
            <input id="statsVacancyId" placeholder="(pega un vacancyId)" />
            <button id="btnLoadStatsVacancy" style="margin-top:10px;">Cargar stats</button>
          </div>
        </div>
        <div class="inline" style="margin-top:10px;">
          <button id="btnClearStats" class="secondary fit">Limpiar</button>
        </div>
        <pre id="statsOut">(sin datos)</pre>
      </section>

      <section class="card">
        <h2>Analytics (Python)</h2>
        <div class="small muted">Resumen de interacciones (últimos 30 días por defecto) servido por FastAPI.</div>
        <div class="inline" style="margin-top:10px;">
          <button id="btnLoadAnalytics" class="fit">Cargar analytics</button>
          <button id="btnClearAnalytics" class="secondary fit">Limpiar</button>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="chart-box"><canvas id="chartProvince" height="220"></canvas></div>
          <div class="chart-box"><canvas id="chartDaily" height="220"></canvas></div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="chart-box"><canvas id="chartIntent" height="220"></canvas></div>
        </div>
        <pre id="analyticsRaw">(sin datos)</pre>
      </section>

      <section class="card">
        <h2>Chatbot (vista consultora)</h2>
        <div class="small muted">Consulta mensajes como consultora. Si incluyes vacancyId se registrará interacción para esa vacante.</div>
        <label>Mensaje</label>
        <input id="chatMessageConsultora" placeholder="Ej: ¿Cuántas interacciones cuentan para peaje?" />
        <label>Vacancy ID (opcional)</label>
        <input id="chatVacancyIdConsultora" placeholder="(pega un vacancyId si quieres asociar)" />
        <div class="inline" style="margin-top:10px;">
          <button id="btnAskConsultora" class="fit">Preguntar</button>
          <button id="btnAskConsultoraHelp" class="secondary fit">Ayuda</button>
          <button id="btnChatbotReplication" class="secondary fit">Replicación (chatbot vivo)</button>
        </div>
        <h3 style="margin-top:14px;">Respuesta</h3>
        <div id="chatOutConsultora" class="chat-box">(sin respuesta)</div>
      </section>

      <section class="card">
        <h2>Generar factura (DGI emulada)</h2>
        <div class="row">
          <div>
            <h3>Parámetros</h3>
            <label>Company ID</label>
            <input id="invCompanyId" placeholder="(companyId)" />
            <label>Periodo inicio (ISO)</label>
            <input id="invStart" placeholder="2025-01-01T00:00:00.000Z" />
            <label>Periodo fin (ISO)</label>
            <input id="invEnd" placeholder="2025-12-31T23:59:59.000Z" />
            <label>Peaje por interacción</label>
            <input id="invToll" placeholder="0.25" />
            <button id="btnGenerate" style="margin-top:10px;">Generar</button>
            <div class="small muted" style="margin-top:10px;">Se genera HTML y se publica por Nginx.</div>
          </div>
          <div>
            <h3>Facturas (Consultora)</h3>
            <div class="inline" style="margin-top:10px;">
              <button id="btnLoadInvoices" class="fit">Cargar</button>
              <button id="btnClearInvoices" class="secondary fit">Limpiar</button>
            </div>
            <div id="invoiceList" class="list" style="margin-top:12px;"></div>
          </div>
        </div>
        <pre id="genOut">(sin datos)</pre>
      </section>
    </main>

    <script src="/app.js?v=1"></script>
    <script>
      (() => {
        if (!window.Bonaparte) {
          alert('No cargó /app.js (JavaScript). Abre la web desde http://localhost:8080/ y revisa la consola (F12).');
          throw new Error('Bonaparte frontend: window.Bonaparte not found');
        }
        const B = window.Bonaparte;
        const TOKEN_KEY = 'bonaparte_consultora_token';
        const chatMessagesConsultora = [];

      function token() {
        return B.getToken(TOKEN_KEY);
      }

      function refreshAuthOut(extra) {
        const payload = token() ? B.decodeJwt(token()) : null;
        B.showJson(B.el('authOut'), {
          loggedIn: Boolean(token()),
          payload,
          ...extra,
        });
      }

      async function login() {
        const data = await B.apiFetch('/api/auth/login', {
          method: 'POST',
          body: { username: B.el('loginUser').value, password: B.el('loginPass').value },
        });
        B.setToken(TOKEN_KEY, data.token);
        refreshAuthOut({ role: data.role });
        B.toast('Sesión consultora iniciada', 'success');
      }

      async function registerConsultora() {
        const data = await B.apiFetch('/api/auth/register/consultora', {
          method: 'POST',
          body: { username: B.el('regUser').value, password: B.el('regPass').value },
        });
        B.setToken(TOKEN_KEY, data.token);
        refreshAuthOut({ registered: true });
        B.toast('Consultora registrada', 'success');
      }

      async function loadStatsCompany() {
        const companyId = B.el('statsCompanyId').value;
        if (!companyId) throw new Error('Ingresa companyId');
        const data = await B.apiFetch(`/api/stats/consultora?companyId=${encodeURIComponent(companyId)}`, { token: token() });
        const out = {
          scope: data.scope,
          company: data.company,
          range: { start: data.start, end: data.end },
          totalInteractions: data.stats && typeof data.stats.total === 'number' ? data.stats.total : null,
          billing: data.billing || null,
          stats: data.stats,
        };
        B.showJson(B.el('statsOut'), out);
        B.toast('Stats empresa cargadas', 'info');
      }

      async function loadStatsVacancy() {
        const vacancyId = B.el('statsVacancyId').value;
        if (!vacancyId) throw new Error('Ingresa vacancyId');
        const data = await B.apiFetch(`/api/stats/consultora?vacancyId=${encodeURIComponent(vacancyId)}`, { token: token() });
        const out = {
          scope: data.scope,
          vacancy: data.vacancy,
          range: { start: data.start, end: data.end },
          totalInteractions: data.stats && typeof data.stats.total === 'number' ? data.stats.total : null,
          billing: data.billing || null,
          stats: data.stats,
        };
        B.showJson(B.el('statsOut'), out);
        B.toast('Stats vacante cargadas', 'info');
      }

      async function generateInvoice() {
        const companyId = B.el('invCompanyId').value;
        if (!companyId) throw new Error('Ingresa companyId');
        const body = {
          companyId,
          periodStart: B.el('invStart').value,
          periodEnd: B.el('invEnd').value,
          tollPerInteraction: Number(B.el('invToll').value || '0.25'),
        };
        const data = await B.apiFetch('/api/invoices/generate', { method: 'POST', token: token(), body });
        B.showJson(B.el('genOut'), data);
        await loadInvoices();
        B.toast('Factura generada', 'success');
      }

      async function loadInvoices() {
        const items = await B.apiFetch('/api/invoices', { token: token() });
        const container = B.el('invoiceList');
        container.innerHTML = '';
        if (!items.length) {
          container.innerHTML = '<div class="small muted">No hay facturas aún.</div>';
          return;
        }

        items.forEach((inv) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.style.margin = '0';
          const link = inv.file && inv.file.publicUrl ? `<a href="${inv.file.publicUrl}" target="_blank" rel="noreferrer">Abrir factura HTML</a>` : '(sin archivo)';
          div.innerHTML = `
            <div class="item-title">Factura ${inv.id}</div>
            <div class="small muted">Company: ${inv.companyId}</div>
            <div class="small muted">Periodo: ${inv.periodStart} → ${inv.periodEnd}</div>
            <div class="small">Interacciones: ${inv.interactionsCount} • Total: ${inv.total}</div>
            <div class="small">${link}</div>
          `;
          container.appendChild(div);
        });
      }

      let provinceChart;
      let dailyChart;
      let intentChart;

      function renderBar(canvasId, labels, dataset, label) {
        const ctx = B.el(canvasId);
        if (!ctx) return;
        if (!window.Chart) {
          B.toast('Chart.js no cargado', 'error');
          return;
        }
        if (canvasId === 'chartProvince' && provinceChart) provinceChart.destroy();
        if (canvasId === 'chartDaily' && dailyChart) dailyChart.destroy();
        if (canvasId === 'chartIntent' && intentChart) intentChart.destroy();

        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label,
                data: dataset,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: { beginAtZero: true },
            },
          },
        });

        if (canvasId === 'chartProvince') provinceChart = chart;
        if (canvasId === 'chartDaily') dailyChart = chart;
        if (canvasId === 'chartIntent') intentChart = chart;
      }

      async function loadAnalytics() {
        let data;
        try {
          data = await B.apiFetch('/api/analytics/summary', { token: token() });
        } catch (e) {
          // Fallback para demos si el backend Python no está disponible
          data = {
            byProvince: [
              { label: 'Panamá', total: 5 },
              { label: 'Chiriquí', total: 3 },
              { label: 'Coclé', total: 2 },
            ],
            daily: [
              { day: '2025-01-01', total: 2 },
              { day: '2025-01-02', total: 4 },
              { day: '2025-01-03', total: 1 },
            ],
            byIntent: [
              { label: 'detalles', total: 4 },
              { label: 'salario', total: 3 },
              { label: 'ubicacion', total: 2 },
            ],
            error: e.message || 'Analytics no disponible',
          };
          B.toast('Analytics offline: usando datos demo', 'warn');
        }

        B.showJson(B.el('analyticsRaw'), data);

        const provinceLabels = (data.byProvince || []).map((x) => x.label);
        const provinceTotals = (data.byProvince || []).map((x) => x.total);
        renderBar('chartProvince', provinceLabels, provinceTotals, 'Interacciones por provincia');

        const dailyLabels = (data.daily || []).map((x) => x.day);
        const dailyTotals = (data.daily || []).map((x) => x.total);
        renderBar('chartDaily', dailyLabels, dailyTotals, 'Interacciones diarias');

        const intentLabels = (data.byIntent || []).map((x) => x.label || x.intent || 'intent');
        const intentTotals = (data.byIntent || []).map((x) => x.total || x.count || 0);
        renderBar('chartIntent', intentLabels, intentTotals, 'Intenciones chatbot');

        B.toast('Analytics cargadas', 'info');
      }

      async function askChatConsultora(message, vacancyId) {
        const payload = { message, vacancyId: vacancyId || undefined };
        const data = await B.apiFetch('/api/chatbot/ask', { method: 'POST', body: payload, token: token() });
        chatMessagesConsultora.push({ from: 'user', text: message || 'Mensaje vacío' });
        chatMessagesConsultora.push({ from: 'bot', text: data.answer?.text || 'Sin respuesta', suggestions: data.answer?.suggestions || [] });
        renderChatConsultora();
        B.toast('Respuesta del chatbot recibida', 'info');
      }

      function renderChatConsultora() {
        const box = B.el('chatOutConsultora');
        if (!chatMessagesConsultora.length) {
          box.textContent = '(sin respuesta)';
          return;
        }
        box.innerHTML = '';
        chatMessagesConsultora.forEach((m) => {
          const div = document.createElement('div');
          div.className = `chat-bubble ${m.from === 'user' ? 'chat-user' : 'chat-bot'}`;
          const meta = document.createElement('div');
          meta.className = 'chat-meta';
          meta.textContent = m.from === 'user' ? 'Tú' : 'Asistente';
          const text = document.createElement('div');
          text.textContent = m.text;
          div.appendChild(meta);
          div.appendChild(text);
          if (m.suggestions && m.suggestions.length) {
            const sug = document.createElement('div');
            sug.className = 'chat-suggestions';
            sug.textContent = 'Sugerencias: ';
            m.suggestions.forEach((s, idx) => {
              const btn = document.createElement('button');
              btn.className = 'secondary fit';
              btn.style.padding = '4px 10px';
              btn.style.marginRight = idx === m.suggestions.length - 1 ? '0' : '6px';
              btn.textContent = s;
              btn.onclick = () => {
                B.el('chatMessageConsultora').value = s;
                B.withButton(B.el('btnAskConsultora'), async () => {
                  await askChatConsultora(s, B.el('chatVacancyIdConsultora').value.trim());
                });
              };
              sug.appendChild(btn);
            });
            div.appendChild(sug);
          }
          box.appendChild(div);
        });

        // Auto-scroll
        try { box.scrollTop = box.scrollHeight; } catch {}
      }

      B.el('btnLogin').onclick = () => B.withButton(B.el('btnLogin'), async () => {
        try { await login(); } catch (e) { B.toast(e.message || 'Error al iniciar sesión', 'error'); }
      });
      B.el('btnLogout').onclick = () => {
        B.clearToken(TOKEN_KEY);
        refreshAuthOut({ loggedOut: true });
        B.toast('Sesión cerrada');
      };
      B.el('btnRegister').onclick = () => B.withButton(B.el('btnRegister'), async () => {
        try { await registerConsultora(); } catch (e) { B.toast(e.message || 'Error al registrar', 'error'); }
      });

      B.el('btnLoadStatsCompany').onclick = () => B.withButton(B.el('btnLoadStatsCompany'), async () => {
        try { await loadStatsCompany(); } catch (e) { B.toast(e.message || 'Error al cargar stats', 'error'); }
      });
      B.el('btnLoadStatsVacancy').onclick = () => B.withButton(B.el('btnLoadStatsVacancy'), async () => {
        try { await loadStatsVacancy(); } catch (e) { B.toast(e.message || 'Error al cargar stats', 'error'); }
      });
      B.el('btnClearStats').onclick = () => {
        B.el('statsCompanyId').value = '';
        B.el('statsVacancyId').value = '';
        B.el('statsOut').textContent = '(sin datos)';
      };

      B.el('btnGenerate').onclick = () => B.withButton(B.el('btnGenerate'), async () => {
        try { await generateInvoice(); } catch (e) { B.toast(e.message || 'Error al generar factura', 'error'); }
      });
      B.el('btnLoadInvoices').onclick = () => B.withButton(B.el('btnLoadInvoices'), async () => {
        try { await loadInvoices(); } catch (e) { B.toast(e.message || 'Error al cargar facturas', 'error'); }
      });
      B.el('btnClearInvoices').onclick = () => (B.el('invoiceList').innerHTML = '');
      B.el('btnLoadCompanies').onclick = () => B.withButton(B.el('btnLoadCompanies'), async () => {
        try { await loadCompanies(); } catch (e) { B.toast(e.message || 'Error al cargar empresas', 'error'); }
      });
      B.el('btnClearCompanies').onclick = () => {
        allCompanies = [];
        companiesPage = 1;
        const list = B.el('companiesList');
        if (list) list.innerHTML = '';
        try { renderCompaniesPager(); } catch {}
      };
      B.el('btnLoadReplication').onclick = () => B.withButton(B.el('btnLoadReplication'), async () => {
        try { await openReplicationLiveWindow(); } catch (e) { B.toast(e.message || 'Error al cargar replicación', 'error'); }
      });
      B.el('btnLoadAnalytics').onclick = () => B.withButton(B.el('btnLoadAnalytics'), async () => {
        try { await loadAnalytics(); } catch (e) { B.toast(e.message || 'Error al cargar analytics', 'error'); }
      });
      B.el('btnClearAnalytics').onclick = () => {
        if (provinceChart) provinceChart.destroy();
        if (dailyChart) dailyChart.destroy();
        if (intentChart) intentChart.destroy();
        B.el('analyticsRaw').textContent = '(sin datos)';
      };

      B.el('btnAskConsultora').onclick = () => B.withButton(B.el('btnAskConsultora'), async () => {
        try {
          const msg = B.el('chatMessageConsultora').value;
          if (!msg) throw new Error('Escribe un mensaje');
          await askChatConsultora(msg, B.el('chatVacancyIdConsultora').value.trim());
        } catch (e) {
          B.toast(e.message || 'Error en chatbot', 'error');
        }
      });

      B.el('btnAskConsultoraHelp').onclick = () => B.withButton(B.el('btnAskConsultoraHelp'), async () => {
        try {
          B.el('chatMessageConsultora').value = 'Ayuda';
          await askChatConsultora('Ayuda', B.el('chatVacancyIdConsultora').value.trim());
        } catch (e) {
          B.toast(e.message || 'Error en chatbot', 'error');
        }
      });

      B.el('btnChatbotReplication').onclick = () => B.withButton(B.el('btnChatbotReplication'), async () => {
        try {
          await openChatbotReplicationLiveWindow();
        } catch (e) {
          B.toast(e.message || 'Error al cargar replicación del chatbot', 'error');
        }
      });

        function buildReplicationHtml(data, companiesData) {
          const targets = (data && data.targets) || {};
          const ordered = [targets.external, targets.internal, targets.proxyWrite, targets.proxyRead].filter(Boolean);

          const esc = (v) => String(v ?? '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

          const statusRows = ordered
            .map((t) => {
              const info = t.info || {};
              const rep = t.replication || {};
              const okText = t.ok ? 'OK' : 'ERROR';
              const lag = rep.secondsBehind === null || rep.secondsBehind === undefined ? '' : String(rep.secondsBehind);
              return `
                <tr>
                  <td>${esc(t.name)}</td>
                  <td>${esc(okText)}</td>
                  <td>${esc(t.host)}:${esc(t.port)}</td>
                  <td>${esc(info.readOnly)}</td>
                  <td>${esc(info.serverId)}</td>
                  <td>${esc(info.version)}</td>
                  <td>${esc(rep.ioRunning || '')}</td>
                  <td>${esc(rep.sqlRunning || '')}</td>
                  <td>${esc(lag)}</td>
                  <td>${esc(rep.sourceHost || '')}</td>
                  <td>${esc(rep.lastError || t.replicationError || t.warning || '')}</td>
                  <td>${esc(t.error || '')}</td>
                </tr>
              `;
            })
            .join('');

          const cols = [
            'name',
            'type',
            'id',
            'commercialName',
            'legalName',
            'ruc',
            'dv',
            'nit',
            'province',
            'district',
            'corregimiento',
            'email',
            'phone',
            'address',
            'createdAt',
            'updatedAt',
          ];

          function renderCompaniesTable(title, payload) {
            const companies = (payload && payload.companies) || [];
            const header = cols.map((c) => `<th>${esc(c)}</th>`).join('');
            const body = companies
              .map((c) => `<tr>${cols.map((k) => `<td>${esc(c[k] ?? '')}</td>`).join('')}</tr>`)
              .join('');
            return `
              <div style="margin-top:14px;">
                <div><b>${esc(title)}</b></div>
                <div style="overflow:auto; max-width:100%;">
                  <table border="1" cellpadding="6" cellspacing="0">
                    <thead><tr>${header}</tr></thead>
                    <tbody>${body || `<tr><td colspan="${cols.length}">(sin empresas)</td></tr>`}</tbody>
                  </table>
                </div>
              </div>
            `;
          }

          const ext = companiesData && companiesData.external;
          const intl = companiesData && companiesData.internal;

          const updatedAt = esc(new Date().toISOString());

          return `
            <div>Actualizado: ${updatedAt}</div>
            <div style="overflow:auto; max-width:100%; margin-top:10px;">
              <table border="1" cellpadding="6" cellspacing="0">
                <thead>
                  <tr>
                    <th>Target</th>
                    <th>Estado</th>
                    <th>Host:Port</th>
                    <th>ReadOnly</th>
                    <th>ServerId</th>
                    <th>Version</th>
                    <th>IO</th>
                    <th>SQL</th>
                    <th>Lag(s)</th>
                    <th>Source</th>
                    <th>Notas/Error Replicación</th>
                    <th>Error Conexión</th>
                  </tr>
                </thead>
                <tbody>
                  ${statusRows || `<tr><td colspan="12">(sin datos)</td></tr>`}
                </tbody>
              </table>
            </div>
            ${renderCompaniesTable(`Primary (externa) ${ext ? `${ext.host}:${ext.port}` : ''}`, ext)}
            ${renderCompaniesTable(`Replica (interna) ${intl ? `${intl.host}:${intl.port}` : ''}`, intl)}
          `;
        }

        async function loadReplicationStatus() {
          const [data, companiesData] = await Promise.all([
            B.apiFetch('/api/replication/status', { token: token() }),
            B.apiFetch('/api/replication/companies', { token: token() }),
          ]);
          const box = B.el('replicationList');
          if (!box) return;
          box.innerHTML = buildReplicationHtml(data, companiesData);

          B.toast('Replicación actualizada', 'info');
        }

        async function openReplicationLiveWindow() {
          const w = window.open('', 'bonaparte_replication_live', 'width=1200,height=800');
          if (!w) {
            // Popup bloqueado
            await loadReplicationStatus();
            B.toast('Popup bloqueado: mostrando en la página', 'warn');
            return;
          }

          // HTML simple, estilo gestor (sin depender de CSS del sitio)
          w.document.open();
          w.document.write(`
            <!doctype html>
            <html lang="es">
              <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <title>Bonaparte - Replicación (vivo)</title>
              </head>
              <body>
                <h2>Replicación (vivo)</h2>
                <div id="content">Cargando...</div>
              </body>
            </html>
          `);
          w.document.close();

          const renderOnce = async () => {
            const [data, companiesData] = await Promise.all([
              B.apiFetch('/api/replication/status', { token: token() }),
              B.apiFetch('/api/replication/companies', { token: token() }),
            ]);
            const el = w.document.getElementById('content');
            if (el) el.innerHTML = buildReplicationHtml(data, companiesData);
          };

          await renderOnce();

          const intervalMs = 3000;
          const timer = setInterval(async () => {
            try {
              if (w.closed) {
                clearInterval(timer);
                return;
              }
              await renderOnce();
            } catch {
              // no-op: si falla un refresh, se reintenta en el siguiente tick
            }
          }, intervalMs);
        }

        function escapeHtml(v) {
          return String(v ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
        }

        function buildChatbotReplicationHtml(data) {
          const updatedAt = escapeHtml((data && data.generatedAt) || new Date().toISOString());
          const ext = data && data.external;
          const intl = data && data.internal;

          const cols = ['createdAt', 'id', 'event', 'intent', 'vacancyId', 'companyId', 'userMessage', 'assistantMessage'];
          const renderTable = (title, block) => {
            const items = (block && block.interactions) || [];
            const body = items
              .map((it) => {
                const userMsg = it.userMessage ? String(it.userMessage) : '';
                const assistantMsg = it.assistantMessage ? String(it.assistantMessage) : '';
                const userShort = userMsg.length > 220 ? `${userMsg.slice(0, 220)}…` : userMsg;
                const assistantShort = assistantMsg.length > 220 ? `${assistantMsg.slice(0, 220)}…` : assistantMsg;
                return `
                  <tr>
                    <td>${escapeHtml(it.createdAt || '')}</td>
                    <td>${escapeHtml(it.id || '')}</td>
                    <td>${escapeHtml(it.event || '')}</td>
                    <td>${escapeHtml(it.intent || '')}</td>
                    <td>${escapeHtml(it.vacancyId || '')}</td>
                    <td>${escapeHtml(it.companyId || '')}</td>
                    <td>${escapeHtml(userShort)}</td>
                    <td>${escapeHtml(assistantShort)}</td>
                  </tr>
                `;
              })
              .join('');

            const hostPort = block ? `${block.host}:${block.port}` : '';
            return `
              <h3>${escapeHtml(title)}</h3>
              <div>Host:Port: ${escapeHtml(hostPort)} • Filtro: channel=chatbot</div>
              <div style="overflow:auto; max-width:100%; margin-top:10px;">
                <table border="1" cellpadding="6" cellspacing="0">
                  <thead>
                    <tr>${cols.map((c) => `<th>${escapeHtml(c)}</th>`).join('')}</tr>
                  </thead>
                  <tbody>${body || `<tr><td colspan="${cols.length}">(sin interacciones)</td></tr>`}</tbody>
                </table>
              </div>
            `;
          };

          return `
            <div>Actualizado: ${updatedAt}</div>
            <div style="margin-top:6px;">Esto compara las últimas interacciones del chatbot entre primary y replica para ver la replicación “en vivo”.</div>
            ${renderTable('Primary (externa)', ext)}
            ${renderTable('Replica (interna)', intl)}
          `;
        }

        async function openChatbotReplicationLiveWindow() {
          const w = window.open('', 'bonaparte_chatbot_replication_live', 'width=1200,height=800');
          if (!w) {
            B.toast('Popup bloqueado', 'warn');
            return;
          }

          w.document.open();
          w.document.write(`
            <!doctype html>
            <html lang="es">
              <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <title>Bonaparte - Replicación (Chatbot en vivo)</title>
              </head>
              <body>
                <h2>Replicación (Chatbot en vivo)</h2>
                <div id="content">Cargando...</div>
              </body>
            </html>
          `);
          w.document.close();

          const renderOnce = async () => {
            const data = await B.apiFetch('/api/replication/chatbot?limit=25', { token: token() });
            const el = w.document.getElementById('content');
            if (el) el.innerHTML = buildChatbotReplicationHtml(data);
          };

          await renderOnce();

          const intervalMs = 3000;
          const timer = setInterval(async () => {
            try {
              if (w.closed) {
                clearInterval(timer);
                return;
              }
              await renderOnce();
            } catch {
              // no-op
            }
          }, intervalMs);
        }

        async function loadCompanies() {
          const items = await B.apiFetch('/api/companies', { token: token() });
          const container = B.el('companiesList');
          const replBox = B.el('replicationList');
          container.innerHTML = '';
          if (replBox) replBox.innerHTML = '';

          // No mostrar empresas usadas por la verificación de replicación en el listado normal
          allCompanies = (items || []).filter((c) => !String(c.name || '').toLowerCase().startsWith('empresa replication'));
          companiesPage = 1;
          renderCompaniesPage();
        }

        const COMPANIES_PAGE_SIZE = 10;
        let allCompanies = [];
        let companiesPage = 1;

        function renderCompaniesPager() {
          const pager = B.el('companiesPager');
          const meta = B.el('companiesPagerMeta');
          const prev = B.el('btnCompaniesPrev');
          const next = B.el('btnCompaniesNext');

          const total = allCompanies.length;
          const totalPages = Math.max(1, Math.ceil(total / COMPANIES_PAGE_SIZE));
          const start = total ? (companiesPage - 1) * COMPANIES_PAGE_SIZE + 1 : 0;
          const end = Math.min(total, companiesPage * COMPANIES_PAGE_SIZE);

          pager.style.display = total > COMPANIES_PAGE_SIZE ? 'flex' : 'none';
          meta.textContent = total
            ? `Mostrando ${start}-${end} de ${total} · Página ${companiesPage}/${totalPages}`
            : 'Sin empresas';

          prev.disabled = companiesPage <= 1;
          next.disabled = companiesPage >= totalPages;
        }

        function renderCompaniesPage() {
          const container = B.el('companiesList');
          if (!container) return;
          container.innerHTML = '';

          if (!allCompanies.length) {
            renderCompaniesPager();
            container.innerHTML = '<div class="small muted">No hay empresas registradas.</div>';
            return;
          }

          const totalPages = Math.max(1, Math.ceil(allCompanies.length / COMPANIES_PAGE_SIZE));
          companiesPage = Math.min(Math.max(1, companiesPage), totalPages);
          const startIdx = (companiesPage - 1) * COMPANIES_PAGE_SIZE;
          const pageItems = allCompanies.slice(startIdx, startIdx + COMPANIES_PAGE_SIZE);

          renderCompaniesPager();

          pageItems.forEach((c) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.margin = '0';
            div.innerHTML = `
              <div class="item-title">${c.name} (${c.type || 'tipo?'})</div>
              <div class="small muted">id: ${c.id}</div>
              <div class="small">Email: ${c.email || 'n/d'} • Tel: ${c.phone || 'n/d'} • Dir: ${c.address || 'n/d'}</div>
            `;
            container.appendChild(div);
          });
        }

        B.el('btnCompaniesPrev').onclick = () => {
          companiesPage = Math.max(1, companiesPage - 1);
          renderCompaniesPage();
        };

        B.el('btnCompaniesNext').onclick = () => {
          const totalPages = Math.max(1, Math.ceil(allCompanies.length / COMPANIES_PAGE_SIZE));
          companiesPage = Math.min(totalPages, companiesPage + 1);
          renderCompaniesPage();
        };

      // defaults
      B.el('invStart').value = B.el('invStart').value || '2025-01-01T00:00:00.000Z';
      B.el('invEnd').value = B.el('invEnd').value || '2025-12-31T23:59:59.000Z';
      B.el('invToll').value = B.el('invToll').value || '0.25';

      refreshAuthOut();
      })();
    </script>
  </body>
</html>
