<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="es" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bonaparte - Consultora</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="nav">
          <span class="brand">Bonaparte</span>
          <a href="/">Público</a>
          <a href="/empresa.html">Empresa</a>
          <a href="/consultora.html">Consultora</a>
          <span class="badge">UI: 8080</span>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="hero">
        <h1>Panel Consultora</h1>
        <p>Gestiona empresas, estadísticas e invoicing del peaje por interacción con un panel claro y protegido.</p>
      </div>
      <section class="card">
        <h2>Consultora: acceso</h2>
        <div class="row">
          <div>
            <h3>Login</h3>
            <label>Username</label>
            <input id="loginUser" placeholder="consultora_demo" />
            <label>Password</label>
            <input id="loginPass" type="password" placeholder="demo123" />
            <div class="inline" style="margin-top:10px;">
              <button id="btnLogin" class="fit">Entrar</button>
              <button id="btnLogout" class="secondary fit">Salir</button>
            </div>
            <div class="small muted" style="margin-top:10px;">Token guardado en LocalStorage (solo demo).</div>
          </div>

          <div>
            <h3>Registro (Consultora)</h3>
            <label>Username</label>
            <input id="regUser" placeholder="consultora_nueva" />
            <label>Password</label>
            <input id="regPass" type="password" placeholder="demo123" />
            <button id="btnRegister" style="margin-top:10px;">Crear cuenta</button>
          </div>
        </div>

        <hr />
        <div class="small muted">Estado actual:</div>
        <pre id="authOut">(sin sesión)</pre>
      </section>

      <section class="card">
        <h2>Empresa consultora</h2>
        <div class="small muted">Datos de referencia y rol en el peaje/facturación (solo informativo en el prototipo).</div>
        <ul class="small">
          <li>Razón social de ejemplo: Consultores Chiriquí, S.A.</li>
          <li>Rol: administra peaje por interacciones y emite factura emulada DGI.</li>
          <li>Acceso sólo con usuario/contraseña de consultora (JWT).</li>
        </ul>
      </section>

      <section class="card">
        <h2>Empresas registradas</h2>
        <div class="inline" style="margin-top:10px;">
          <button id="btnLoadCompanies" class="fit">Cargar empresas</button>
          <button id="btnClearCompanies" class="secondary fit">Limpiar</button>
        </div>
        <div id="companiesList" class="list" style="margin-top:12px;"></div>
      </section>

      <section class="card">
        <h2>Estadísticas</h2>
        <div class="row">
          <div>
            <h3>Por empresa</h3>
            <label>Company ID</label>
            <input id="statsCompanyId" placeholder="(pega un companyId)" />
            <button id="btnLoadStatsCompany" style="margin-top:10px;">Cargar stats</button>
          </div>
          <div>
            <h3>Por vacante</h3>
            <label>Vacancy ID</label>
            <input id="statsVacancyId" placeholder="(pega un vacancyId)" />
            <button id="btnLoadStatsVacancy" style="margin-top:10px;">Cargar stats</button>
          </div>
        </div>
        <pre id="statsOut">(sin datos)</pre>
      </section>

      <section class="card">
        <h2>Analytics (Python)</h2>
        <div class="small muted">Resumen de interacciones (últimos 30 días por defecto) servido por FastAPI.</div>
        <div class="inline" style="margin-top:10px;">
          <button id="btnLoadAnalytics" class="fit">Cargar analytics</button>
          <button id="btnClearAnalytics" class="secondary fit">Limpiar</button>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="chart-box"><canvas id="chartProvince" height="220"></canvas></div>
          <div class="chart-box"><canvas id="chartDaily" height="220"></canvas></div>
        </div>
        <pre id="analyticsRaw">(sin datos)</pre>
      </section>

      <section class="card">
        <h2>Chatbot (vista consultora)</h2>
        <div class="small muted">Consulta mensajes como consultora. Si incluyes vacancyId se registrará interacción para esa vacante.</div>
        <label>Mensaje</label>
        <input id="chatMessageConsultora" placeholder="Ej: ¿Cuántas interacciones cuentan para peaje?" />
        <label>Vacancy ID (opcional)</label>
        <input id="chatVacancyIdConsultora" placeholder="(pega un vacancyId si quieres asociar)" />
        <div class="inline" style="margin-top:10px;">
          <button id="btnAskConsultora" class="fit">Preguntar</button>
          <button id="btnAskConsultoraHelp" class="secondary fit">Ayuda</button>
        </div>
        <h3 style="margin-top:14px;">Respuesta</h3>
        <pre id="chatOutConsultora">(sin respuesta)</pre>
      </section>

      <section class="card">
        <h2>Generar factura (DGI emulada)</h2>
        <div class="row">
          <div>
            <h3>Parámetros</h3>
            <label>Company ID</label>
            <input id="invCompanyId" placeholder="(companyId)" />
            <label>Periodo inicio (ISO)</label>
            <input id="invStart" placeholder="2025-01-01T00:00:00.000Z" />
            <label>Periodo fin (ISO)</label>
            <input id="invEnd" placeholder="2025-12-31T23:59:59.000Z" />
            <label>Peaje por interacción</label>
            <input id="invToll" placeholder="0.25" />
            <button id="btnGenerate" style="margin-top:10px;">Generar</button>
            <div class="small muted" style="margin-top:10px;">Se genera HTML y se publica por Nginx.</div>
          </div>
          <div>
            <h3>Facturas (Consultora)</h3>
            <div class="inline" style="margin-top:10px;">
              <button id="btnLoadInvoices" class="fit">Cargar</button>
              <button id="btnClearInvoices" class="secondary fit">Limpiar</button>
            </div>
            <div id="invoiceList" class="list" style="margin-top:12px;"></div>
          </div>
        </div>
        <pre id="genOut">(sin datos)</pre>
      </section>
    </main>

    <script src="/app.js?v=1"></script>
    <script>
      (() => {
        if (!window.Bonaparte) {
          alert('No cargó /app.js (JavaScript). Abre la web desde http://localhost:8080/ y revisa la consola (F12).');
          throw new Error('Bonaparte frontend: window.Bonaparte not found');
        }
        const B = window.Bonaparte;
        const TOKEN_KEY = 'bonaparte_consultora_token';

      function token() {
        return B.getToken(TOKEN_KEY);
      }

      function refreshAuthOut(extra) {
        const payload = token() ? B.decodeJwt(token()) : null;
        B.showJson(B.el('authOut'), {
          loggedIn: Boolean(token()),
          payload,
          ...extra,
        });
      }

      async function login() {
        const data = await B.apiFetch('/api/auth/login', {
          method: 'POST',
          body: { username: B.el('loginUser').value, password: B.el('loginPass').value },
        });
        B.setToken(TOKEN_KEY, data.token);
        refreshAuthOut({ role: data.role });
        B.toast('Sesión consultora iniciada', 'success');
      }

      async function registerConsultora() {
        const data = await B.apiFetch('/api/auth/register/consultora', {
          method: 'POST',
          body: { username: B.el('regUser').value, password: B.el('regPass').value },
        });
        B.setToken(TOKEN_KEY, data.token);
        refreshAuthOut({ registered: true });
        B.toast('Consultora registrada', 'success');
      }

      async function loadStatsCompany() {
        const companyId = B.el('statsCompanyId').value;
        if (!companyId) throw new Error('Ingresa companyId');
        const data = await B.apiFetch(`/api/stats/consultora?companyId=${encodeURIComponent(companyId)}`, { token: token() });
        B.showJson(B.el('statsOut'), data);
        B.toast('Stats empresa cargadas', 'info');
      }

      async function loadStatsVacancy() {
        const vacancyId = B.el('statsVacancyId').value;
        if (!vacancyId) throw new Error('Ingresa vacancyId');
        const data = await B.apiFetch(`/api/stats/consultora?vacancyId=${encodeURIComponent(vacancyId)}`, { token: token() });
        B.showJson(B.el('statsOut'), data);
        B.toast('Stats vacante cargadas', 'info');
      }

      async function generateInvoice() {
        const companyId = B.el('invCompanyId').value;
        if (!companyId) throw new Error('Ingresa companyId');
        const body = {
          companyId,
          periodStart: B.el('invStart').value,
          periodEnd: B.el('invEnd').value,
          tollPerInteraction: Number(B.el('invToll').value || '0.25'),
        };
        const data = await B.apiFetch('/api/invoices/generate', { method: 'POST', token: token(), body });
        B.showJson(B.el('genOut'), data);
        await loadInvoices();
        B.toast('Factura generada', 'success');
      }

      async function loadInvoices() {
        const items = await B.apiFetch('/api/invoices', { token: token() });
        const container = B.el('invoiceList');
        container.innerHTML = '';
        if (!items.length) {
          container.innerHTML = '<div class="small muted">No hay facturas aún.</div>';
          return;
        }

        items.forEach((inv) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.style.margin = '0';
          const link = inv.file && inv.file.publicUrl ? `<a href="${inv.file.publicUrl}" target="_blank" rel="noreferrer">Abrir factura HTML</a>` : '(sin archivo)';
          div.innerHTML = `
            <div class="item-title">Factura ${inv.id}</div>
            <div class="small muted">Company: ${inv.companyId}</div>
            <div class="small muted">Periodo: ${inv.periodStart} → ${inv.periodEnd}</div>
            <div class="small">Interacciones: ${inv.interactionsCount} • Total: ${inv.total}</div>
            <div class="small">${link}</div>
          `;
          container.appendChild(div);
        });
      }

      let provinceChart;
      let dailyChart;

      function renderBar(canvasId, labels, dataset, label) {
        const ctx = B.el(canvasId);
        if (!ctx) return;
        if (!window.Chart) {
          B.toast('Chart.js no cargado', 'error');
          return;
        }
        if (canvasId === 'chartProvince' && provinceChart) provinceChart.destroy();
        if (canvasId === 'chartDaily' && dailyChart) dailyChart.destroy();

        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label,
                data: dataset,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: { beginAtZero: true },
            },
          },
        });

        if (canvasId === 'chartProvince') provinceChart = chart;
        if (canvasId === 'chartDaily') dailyChart = chart;
      }

      async function loadAnalytics() {
        const data = await B.apiFetch('/api/analytics/summary', { token: token() });
        B.showJson(B.el('analyticsRaw'), data);

        const provinceLabels = (data.byProvince || []).map((x) => x.label);
        const provinceTotals = (data.byProvince || []).map((x) => x.total);
        renderBar('chartProvince', provinceLabels, provinceTotals, 'Interacciones por provincia');

        const dailyLabels = (data.daily || []).map((x) => x.day);
        const dailyTotals = (data.daily || []).map((x) => x.total);
        renderBar('chartDaily', dailyLabels, dailyTotals, 'Interacciones diarias');

        B.toast('Analytics cargadas', 'info');
      }

      async function askChatConsultora(message, vacancyId) {
        const payload = { message, vacancyId: vacancyId || undefined };
        const data = await B.apiFetch('/api/chatbot/ask', { method: 'POST', body: payload, token: token() });
        B.showJson(B.el('chatOutConsultora'), data);
        B.toast('Respuesta del chatbot recibida', 'info');
      }

      B.el('btnLogin').onclick = () => B.withButton(B.el('btnLogin'), async () => {
        try { await login(); } catch (e) { B.toast(e.message || 'Error al iniciar sesión', 'error'); }
      });
      B.el('btnLogout').onclick = () => {
        B.clearToken(TOKEN_KEY);
        refreshAuthOut({ loggedOut: true });
        B.toast('Sesión cerrada');
      };
      B.el('btnRegister').onclick = () => B.withButton(B.el('btnRegister'), async () => {
        try { await registerConsultora(); } catch (e) { B.toast(e.message || 'Error al registrar', 'error'); }
      });

      B.el('btnLoadStatsCompany').onclick = () => B.withButton(B.el('btnLoadStatsCompany'), async () => {
        try { await loadStatsCompany(); } catch (e) { B.toast(e.message || 'Error al cargar stats', 'error'); }
      });
      B.el('btnLoadStatsVacancy').onclick = () => B.withButton(B.el('btnLoadStatsVacancy'), async () => {
        try { await loadStatsVacancy(); } catch (e) { B.toast(e.message || 'Error al cargar stats', 'error'); }
      });

      B.el('btnGenerate').onclick = () => B.withButton(B.el('btnGenerate'), async () => {
        try { await generateInvoice(); } catch (e) { B.toast(e.message || 'Error al generar factura', 'error'); }
      });
      B.el('btnLoadInvoices').onclick = () => B.withButton(B.el('btnLoadInvoices'), async () => {
        try { await loadInvoices(); } catch (e) { B.toast(e.message || 'Error al cargar facturas', 'error'); }
      });
      B.el('btnClearInvoices').onclick = () => (B.el('invoiceList').innerHTML = '');
      B.el('btnLoadCompanies').onclick = () => B.withButton(B.el('btnLoadCompanies'), async () => {
        try { await loadCompanies(); } catch (e) { B.toast(e.message || 'Error al cargar empresas', 'error'); }
      });
      B.el('btnClearCompanies').onclick = () => (B.el('companiesList').innerHTML = '');
      B.el('btnLoadAnalytics').onclick = () => B.withButton(B.el('btnLoadAnalytics'), async () => {
        try { await loadAnalytics(); } catch (e) { B.toast(e.message || 'Error al cargar analytics', 'error'); }
      });
      B.el('btnClearAnalytics').onclick = () => {
        if (provinceChart) provinceChart.destroy();
        if (dailyChart) dailyChart.destroy();
        B.el('analyticsRaw').textContent = '(sin datos)';
      };

      B.el('btnAskConsultora').onclick = () => B.withButton(B.el('btnAskConsultora'), async () => {
        try {
          const msg = B.el('chatMessageConsultora').value;
          if (!msg) throw new Error('Escribe un mensaje');
          await askChatConsultora(msg, B.el('chatVacancyIdConsultora').value.trim());
        } catch (e) {
          B.toast(e.message || 'Error en chatbot', 'error');
        }
      });

      B.el('btnAskConsultoraHelp').onclick = () => B.withButton(B.el('btnAskConsultoraHelp'), async () => {
        try {
          B.el('chatMessageConsultora').value = 'Ayuda';
          await askChatConsultora('Ayuda', B.el('chatVacancyIdConsultora').value.trim());
        } catch (e) {
          B.toast(e.message || 'Error en chatbot', 'error');
        }
      });

        async function loadCompanies() {
          const items = await B.apiFetch('/api/companies', { token: token() });
          const container = B.el('companiesList');
          container.innerHTML = '';

          if (!items.length) {
            container.innerHTML = '<div class="small muted">No hay empresas registradas.</div>';
            return;
          }

          items.forEach((c) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.margin = '0';
            div.innerHTML = `
              <div class="item-title">${c.name} (${c.type || 'tipo?'})</div>
              <div class="small muted">id: ${c.id}</div>
              <div class="small">Email: ${c.email || 'n/d'} • Tel: ${c.phone || 'n/d'} • Dir: ${c.address || 'n/d'}</div>
            `;
            container.appendChild(div);
          });
        }

      // defaults
      B.el('invStart').value = B.el('invStart').value || '2025-01-01T00:00:00.000Z';
      B.el('invEnd').value = B.el('invEnd').value || '2025-12-31T23:59:59.000Z';
      B.el('invToll').value = B.el('invToll').value || '0.25';

      refreshAuthOut();
      })();
    </script>
  </body>
</html>
