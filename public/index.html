<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bonaparte - Público</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .stats-box { margin-top: 12px; padding: 10px; border: 1px solid #2d3748; border-radius: 10px; background: #0f172a; }
      .stats-title { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
      .stats-meta { font-size: 12px; color: #94a3b8; margin-bottom: 8px; }
      .stats-bars { display: grid; gap: 6px; }
      .stats-row { display: grid; grid-template-columns: 120px 1fr 60px; align-items: center; gap: 8px; font-size: 13px; }
      .stats-bar { height: 8px; border-radius: 999px; background: linear-gradient(90deg, #38bdf8, #6366f1); }
      .stats-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #1e293b; color: #e2e8f0; font-size: 12px; }
      .chat-box { background: #0b1220; border: 1px solid #1f2937; border-radius: 12px; padding: 10px; min-height: 120px; }
      .chat-bubble { margin-bottom: 10px; padding: 10px; border-radius: 10px; line-height: 1.4; }
      .chat-user { background: #0ea5e9; color: #0b1220; text-align: right; }
      .chat-bot { background: #111827; color: #e5e7eb; border: 1px solid #1f2937; }
      .chat-meta { font-size: 12px; color: #cbd5e1; margin-bottom: 4px; }
      .chat-suggestions { font-size: 12px; color: #a5b4fc; margin-top: 6px; }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="nav">
          <span class="brand">Bonaparte</span>
          <a href="/">Público</a>
          <a href="/empresa.html">Empresa</a>
          <a href="/consultora.html">Consultora</a>
          <a href="/login.html">Login</a>
          <button id="btnLogout" class="secondary" style="padding:6px 12px;">Logout</button>
          <span class="badge">UI: 8080</span>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="hero">
        <h1>Portal Público</h1>
        <p>Acceso a vacantes simuladas en Panamá. Cada interacción (acceso, detalle, chat) alimenta el peaje que factura la consultora.</p>
        <div class="inline" style="margin-top:10px; gap:8px; flex-wrap:wrap;">
          <span class="badge">Panamá</span>
          <span class="badge">Interacciones → Peaje</span>
          <span class="badge">Datos académicos</span>
        </div>
      </div>

      <section class="card">
        <h2>Presentación</h2>
        <p>Bonaparte es un prototipo de portal laboral para Panamá que muestra vacantes públicas y privadas, registra interacciones y genera facturación emulada (HTML tipo DGI).</p>
        <div class="row">
          <div>
            <h3>Visión</h3>
            <p>Ser el portal de referencia para talento y empresas en Panamá con trazabilidad de interacciones y cobro justo por visibilidad.</p>
          </div>
          <div>
            <h3>Misión</h3>
            <p>Conectar vacantes verificables por provincia, medir accesos/chats y ofrecer transparencia en el peaje y la facturación simulada.</p>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div>
            <h3>Servicios</h3>
            <ul class="small">
              <li>Listado público de vacantes (sin registro).</li>
              <li>Chatbot contextual con registro de interacciones.</li>
              <li>Estadísticas por vacante/empresa para consultora.</li>
              <li>Facturación HTML emulada con ITBMS.</li>
            </ul>
          </div>
          <div>
            <h3>Ubicación</h3>
            <ul class="small">
              <li>Contexto: provincias de Panamá (simulado).</li>
              <li>Frontend: Nginx 8080.</li>
              <li>API: 3001.</li>
              <li>Analytics: 8000 (FastAPI opcional).</li>
            </ul>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Visión y Misión (simulado)</h2>
        <p><strong>Visión:</strong> Ser el portal panameño de referencia para conectar talento con empresas públicas y privadas, midiendo interacciones para garantizar transparencia en el peaje.</p>
        <p><strong>Misión:</strong> Facilitar vacantes verificables por provincia de Panamá, registrar cada interacción (acceso, detalle, chat) y ofrecer trazabilidad para facturación emulada tipo DGI.</p>
        <div class="small muted">Datos académicos y simulados; no requieren registro.</div>
      </section>
      <div class="row">
        <section class="card">
          <h2>Vacantes</h2>
          <div class="small muted">Lista pública Panamá. Al abrir una vacante se registra una interacción (acceso) que suma al peaje.</div>

          <div class="inline" style="margin-top: 10px;">
            <button id="btnLoad" class="fit">Cargar vacantes</button>
            <button id="btnClear" class="secondary fit">Limpiar</button>
          </div>

          <div id="vacPager" class="inline pager" style="margin-top:10px; display:none;">
            <button id="btnVacPrev" class="secondary fit">Anterior</button>
            <div id="vacPagerMeta" class="pager-meta"></div>
            <button id="btnVacNext" class="secondary fit">Siguiente</button>
          </div>

          <div id="vacancies" class="list" style="margin-top: 12px;"></div>
        </section>

        <section class="card">
          <h2>Chatbot</h2>
          <div class="small muted">Guía de dudas. Si hay una vacante seleccionada, registrarás interacción por chat asociada a la vacante.</div>

          <label>Vacante seleccionada</label>
          <div id="selectedVacancy" class="small">(ninguna)</div>

          <label>Mensaje</label>
          <input id="chatMessage" placeholder="Ej: ¿Qué es el peaje y cómo se factura?" />

          <div class="inline" style="margin-top: 10px;">
            <button id="btnAsk" class="fit">Preguntar</button>
            <button id="btnAskHelp" class="secondary fit">Ayuda</button>
            <button id="btnChatClear" class="secondary fit">Limpiar chat</button>
          </div>

          <h3 style="margin-top: 14px;">Respuesta</h3>
          <div id="chatOut" class="chat-box">(sin respuesta)</div>
          <div id="chatStats" class="stats-box" aria-live="polite">
            <div class="stats-title">Estadísticas de la vacante (últimos 30 días)</div>
            <div class="stats-meta">Selecciona una vacante y pregunta algo para ver interacciones registradas (peaje).</div>
            <div class="stats-bars" id="chatStatsContent"></div>
          </div>
        </section>
      </div>

      <section class="card">
        <h2>Detalle de vacante</h2>
        <div class="small muted">Se llena cuando haces click en una vacante. Muestra provincia panameña (o valor simulado) y tipo de empresa.</div>
        <pre id="vacancyOut">(sin selección)</pre>
      </section>
    </main>

    <script src="/app.js?v=1"></script>
    <script>
      (() => {
        if (!window.Bonaparte) {
          alert('No cargó /app.js (JavaScript). Abre la web desde http://localhost:8080/ y revisa la consola (F12).');
          throw new Error('Bonaparte frontend: window.Bonaparte not found');
        }
        const B = window.Bonaparte;
        const TOKEN_KEY = 'bonaparte_login_token';

        function token() {
          return B.getToken(TOKEN_KEY);
        }

        function ensureAuth() {
          const t = token();
          if (!t) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
            return false;
          }
          const payload = B.decodeJwt(t) || {};
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = `${payload.username || 'usuario'} · ${payload.role || 'rol?'}`;
          document.querySelector('.nav').appendChild(badge);
          return true;
        }

        B.el('btnLogout').onclick = () => {
          B.clearToken(TOKEN_KEY);
          const next = encodeURIComponent(location.pathname + location.search);
          location.href = `/login.html?next=${next}`;
        };

        const PROVINCES = [
          'panamá',
          'panama',
          'panamá oeste',
          'panama oeste',
          'chiriquí',
          'chiriqui',
          'veraguas',
          'coclé',
          'cocle',
          'herrera',
          'los santos',
          'colón',
          'colon',
          'darién',
          'darien',
          'bocas del toro',
        ];

        // Mapa de tipos de empresa conocido (semilla). Si no se conoce, se asume privada (simulado).
        const COMPANY_TYPES = {
          '11111111-1111-1111-1111-111111111111': 'Privada',
          '22222222-2222-2222-2222-222222222222': 'Pública',
          '33333333-3333-3333-3333-333333333333': 'Privada',
        };

        let selectedVacancyId = null;
        let selectedVacancyTitle = null;
        const chatMessages = [];

      function findProvince(value) {
        const text = String(value || '').toLowerCase();
        const hit = PROVINCES.find((p) => text.includes(p));
        if (hit) {
          // normalizamos mayúsculas para mostrar bonito
          return hit
            .split(' ')
            .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
            .join(' ')
            .replace('Panama', 'Panamá')
            .replace('Chiriqui', 'Chiriquí')
            .replace('Cocle', 'Coclé')
            .replace('Colon', 'Colón')
            .replace('Darien', 'Darién');
        }
        return 'Panamá (simulado)';
      }

      function companyTypeLabel(v) {
        const known = v && v.companyId ? COMPANY_TYPES[v.companyId] : null;
        return known ? `${known} (simulado)` : 'Privada (simulado)';
      }

      function shortId(id) {
        const s = String(id || '');
        return s.length > 10 ? `${s.slice(0, 8)}…` : s;
      }

      function setSelectedVacancy(v) {
        selectedVacancyId = v ? v.id : null;
        selectedVacancyTitle = v ? v.title : null;
        B.el('selectedVacancy').textContent = selectedVacancyId
          ? `${selectedVacancyTitle} (${shortId(selectedVacancyId)})`
          : '(ninguna)';
      }

      function renderChat() {
        const box = B.el('chatOut');
        if (!chatMessages.length) {
          box.textContent = '(sin respuesta)';
          return;
        }
        box.innerHTML = '';
        chatMessages.forEach((m) => {
          const div = document.createElement('div');
          div.className = `chat-bubble ${m.from === 'user' ? 'chat-user' : 'chat-bot'}`;
          const meta = document.createElement('div');
          meta.className = 'chat-meta';
          meta.textContent = m.from === 'user' ? 'Tú' : 'Asistente';
          const text = document.createElement('div');
          text.textContent = m.text;
          div.appendChild(meta);
          div.appendChild(text);
          if (m.suggestions && m.suggestions.length) {
            const sug = document.createElement('div');
            sug.className = 'chat-suggestions';
            sug.textContent = 'Sugerencias: ';
            m.suggestions.forEach((s, idx) => {
              const btn = document.createElement('button');
              btn.className = 'secondary';
              btn.style.padding = '4px 10px';
              btn.style.marginRight = idx === m.suggestions.length - 1 ? '0' : '6px';
              btn.textContent = s;
              btn.onclick = () => {
                B.el('chatMessage').value = s;
                B.withButton(B.el('btnAsk'), async () => {
                  await askChat(s);
                });
              };
              sug.appendChild(btn);
            });
            div.appendChild(sug);
          }
          box.appendChild(div);
        });

        // Auto-scroll to latest message
        try { box.scrollTop = box.scrollHeight; } catch {}
      }

      async function loadVacancies() {
        const items = await B.apiFetch('/api/vacancies');
        allVacancies = Array.isArray(items) ? items : [];
        currentVacPage = 1;
        renderVacanciesPage();
      }

      const VAC_PAGE_SIZE = 10;
      let allVacancies = [];
      let currentVacPage = 1;

      function renderVacPager() {
        const pager = B.el('vacPager');
        const meta = B.el('vacPagerMeta');
        const prev = B.el('btnVacPrev');
        const next = B.el('btnVacNext');

        const total = allVacancies.length;
        const totalPages = Math.max(1, Math.ceil(total / VAC_PAGE_SIZE));
        const start = total ? (currentVacPage - 1) * VAC_PAGE_SIZE + 1 : 0;
        const end = Math.min(total, currentVacPage * VAC_PAGE_SIZE);

        if (total > VAC_PAGE_SIZE) {
          pager.style.display = 'flex';
        } else {
          pager.style.display = 'none';
        }

        meta.textContent = total
          ? `Mostrando ${start}-${end} de ${total} · Página ${currentVacPage}/${totalPages}`
          : 'Sin vacantes';

        prev.disabled = currentVacPage <= 1;
        next.disabled = currentVacPage >= totalPages;
      }

      function renderVacanciesPage() {
        const container = B.el('vacancies');
        container.innerHTML = '';

        if (!allVacancies.length) {
          renderVacPager();
          container.innerHTML = '<div class="small muted">No hay vacantes aún.</div>';
          return;
        }

        const totalPages = Math.max(1, Math.ceil(allVacancies.length / VAC_PAGE_SIZE));
        currentVacPage = Math.min(Math.max(1, currentVacPage), totalPages);
        const startIdx = (currentVacPage - 1) * VAC_PAGE_SIZE;
        const pageItems = allVacancies.slice(startIdx, startIdx + VAC_PAGE_SIZE);

        renderVacPager();

        pageItems.forEach((v) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.style.margin = '0';
          div.innerHTML = `
            <div class="item-title">${v.title}</div>
            <div class="small muted">${v.location || 'Ubicación no enviada'} ${v.status ? '• ' + v.status : ''}</div>
            <div class="small">Provincia: ${findProvince(v.location)}</div>
            <div class="small">Tipo de empresa: <span class="badge">${companyTypeLabel(v)}</span></div>
            <div class="small" title="${v.companyId}">companyId: ${shortId(v.companyId)}</div>
            <div class="inline" style="margin-top: 10px;">
              <button class="fit">Abrir</button>
              <button class="secondary fit">Seleccionar para Chatbot</button>
            </div>
          `;

          const [btnOpen, btnSelect] = div.querySelectorAll('button');

          btnOpen.onclick = async () => {
            const detail = await B.apiFetch(`/api/vacancies/${v.id}`);
            const enriched = {
              ...detail,
              uiProvince: findProvince(detail.location),
              uiCompanyType: companyTypeLabel(detail),
              uiNotas: 'Interacción registrada al abrir. Datos simulados para Panamá.',
            };
            B.showJson(B.el('vacancyOut'), enriched);
            setSelectedVacancy({ id: v.id, title: v.title });
          };

          btnSelect.onclick = () => {
            setSelectedVacancy({ id: v.id, title: v.title });
          };

          container.appendChild(div);
        });
      }

      B.el('btnVacPrev').onclick = () => {
        currentVacPage = Math.max(1, currentVacPage - 1);
        renderVacanciesPage();
      };

      B.el('btnVacNext').onclick = () => {
        const totalPages = Math.max(1, Math.ceil(allVacancies.length / VAC_PAGE_SIZE));
        currentVacPage = Math.min(totalPages, currentVacPage + 1);
        renderVacanciesPage();
      };

      async function askChat(message) {
        const payload = {
          message,
          vacancyId: selectedVacancyId,
        };
        const data = await B.apiFetch('/api/chatbot/ask', { method: 'POST', body: payload });
        chatMessages.push({ from: 'user', text: message || 'Mensaje vacío' });
        chatMessages.push({ from: 'bot', text: data.answer?.text || 'Sin respuesta', suggestions: data.answer?.suggestions || [] });
        renderChat();
        renderChatStats(data.stats);
      }

      function renderBars(container, rows, labelKey, valueKey) {
        const max = Math.max(...rows.map((r) => Number(r[valueKey]) || 0), 1);
        container.innerHTML = '';
        rows.forEach((r) => {
          const label = r[labelKey];
          const val = Number(r[valueKey]) || 0;
          const pct = Math.max(4, Math.min(100, (val / max) * 100));
          const row = document.createElement('div');
          row.className = 'stats-row';
          row.innerHTML = `
            <span>${label}</span>
            <div class="stats-bar" style="width:${pct}%"></div>
            <span class="stats-badge">${val}</span>
          `;
          container.appendChild(row);
        });
      }

      function renderChatStats(stats) {
        const box = B.el('chatStatsContent');
        if (!stats) {
          box.innerHTML = '<div class="small muted">Aún no hay estadísticas; selecciona una vacante y consulta al chatbot.</div>';
          return;
        }

        const { byChannel = [], byEvent = [], totalInteractions = 0 } = stats;
        const frag = document.createDocumentFragment();

        const totalDiv = document.createElement('div');
        totalDiv.className = 'stats-meta';
        totalDiv.textContent = `Total de interacciones: ${totalInteractions}`;
        frag.appendChild(totalDiv);

        if (byChannel.length) {
          const title = document.createElement('div');
          title.className = 'stats-title';
          title.textContent = 'Por canal';
          frag.appendChild(title);
          const wrap = document.createElement('div');
          wrap.className = 'stats-bars';
          renderBars(wrap, byChannel.map((c) => ({ label: c.channel, value: c.count })), 'label', 'value');
          frag.appendChild(wrap);
        }

        if (byEvent.length) {
          const title = document.createElement('div');
          title.className = 'stats-title';
          title.textContent = 'Por evento';
          frag.appendChild(title);
          const wrap = document.createElement('div');
          wrap.className = 'stats-bars';
          renderBars(wrap, byEvent.map((e) => ({ label: e.event, value: e.count })), 'label', 'value');
          frag.appendChild(wrap);
        }

        box.innerHTML = '';
        box.appendChild(frag);
      }

      B.el('btnLoad').onclick = () => B.withButton(B.el('btnLoad'), async () => {
        try {
          await loadVacancies();
          B.toast('Vacantes cargadas', 'success');
        } catch (e) {
          B.toast(e.message || 'Error al cargar vacantes', 'error');
        }
      });

      B.el('btnClear').onclick = () => {
        B.el('vacancies').innerHTML = '';
        B.el('vacancyOut').textContent = '(sin selección)';
        allVacancies = [];
        currentVacPage = 1;
        try { renderVacPager(); } catch {}
        chatMessages.length = 0;
        renderChat();
        B.el('chatStatsContent').innerHTML = '<div class="small muted">Aún no hay estadísticas; selecciona una vacante y consulta al chatbot.</div>';
        setSelectedVacancy(null);
      };

      B.el('btnAsk').onclick = () => B.withButton(B.el('btnAsk'), async () => {
        try {
          const msg = B.el('chatMessage').value;
          await askChat(msg);
        } catch (e) {
          B.toast(e.message || 'Error en chatbot', 'error');
        }
      });

      B.el('btnAskHelp').onclick = () => B.withButton(B.el('btnAskHelp'), async () => {
        try {
          B.el('chatMessage').value = 'Ayuda';
          await askChat('Ayuda');
        } catch (e) {
          B.toast(e.message || 'Error en chatbot', 'error');
        }
      });

      B.el('btnChatClear').onclick = () => {
        chatMessages.length = 0;
        renderChat();
        B.el('chatMessage').value = '';
        B.toast('Chat limpiado', 'info');
      };

      // Autoload (solo si hay token)
      if (ensureAuth()) {
        loadVacancies().catch(() => {});
        renderChatStats(null);
      }
      })();
    </script>
  </body>
</html>
