name: bonaparte-replication

services:
  # Relacional (EXTERNA) - Primary / Writer
  mysql-external:
    build:
      context: ../database/mysql/replication/images/mysql-external
    image: bonaparte-mysql-external:8.4
    container_name: bonaparte-mysql-external
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD:-yourpassword}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD:-replpassword}
    ports:
      - "3307:3306"
    volumes:
      - mysql_external_data:/var/lib/mysql
      - ../database/mysql/replication/primary-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-p${MYSQL_PASSWORD:-yourpassword}"]
      interval: 5s
      timeout: 3s
      retries: 30

  # Relacional (INTERNA) - Replica / Reader
  mysql-internal:
    build:
      context: ../database/mysql/replication/images/mysql-internal
    image: bonaparte-mysql-internal:8.4
    container_name: bonaparte-mysql-internal
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD:-yourpassword}
    ports:
      - "3308:3306"
    volumes:
      - mysql_internal_data:/var/lib/mysql
      - ../database/mysql/replication/replica-init:/docker-entrypoint-initdb.d:ro
    depends_on:
      mysql-external:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-p${MYSQL_PASSWORD:-yourpassword}"]
      interval: 5s
      timeout: 3s
      retries: 30

  # Configura la replicaciÃ³n (GTID) en la replica (interno)
  mysql-replication-setup:
    image: mysql:8.4
    container_name: bonaparte-mysql-replication-setup
    depends_on:
      mysql-external:
        condition: service_healthy
      mysql-internal:
        condition: service_healthy
    restart: "no"
    environment:
      MYSQL_PWD: ${MYSQL_PASSWORD:-yourpassword}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD:-replpassword}
    command: >-
      bash -lc "
        echo 'Configuring replication (external -> internal)...';
        mysql -h mysql-internal -uroot -e \"STOP REPLICA; CHANGE REPLICATION SOURCE TO SOURCE_HOST='mysql-external', SOURCE_USER='repl', SOURCE_PASSWORD='${MYSQL_REPL_PASSWORD:-replpassword}', SOURCE_AUTO_POSITION=1, GET_SOURCE_PUBLIC_KEY=1; START REPLICA;\";
        mysql -h mysql-internal -uroot -e \"SHOW REPLICA STATUS\\G\" | head -n 60;
        echo 'Replication configured.';
      "

  # Balanceo simple
  # - 6033: escritura -> externa (primary)
  # - 6034: lectura   -> interna (replica)
  haproxy:
    image: haproxy:2.9
    container_name: bonaparte-haproxy
    depends_on:
      mysql-external:
        condition: service_healthy
      mysql-internal:
        condition: service_healthy
    ports:
      - "6033:6033"
      - "6034:6034"
    volumes:
      - ../database/mysql/replication/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro

volumes:
  mysql_external_data:
  mysql_internal_data:
